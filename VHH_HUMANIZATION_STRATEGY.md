# VHH人源化匹配策略说明

## 🎯 最新优化（已完成）

### 1. 基于CDR构型的框架筛选 ✅
- 在模板选择阶段，基于VHH的CDR构型对Human模板进行筛选
- 自动过滤掉CDR兼容性得分过低的模板（阈值：0.7）
- 确保选中的模板能够支持VHH的CDR构型

### 2. 关键位置检查 ✅
- 提取并检查影响CDR构型的关键位置：
  - **FR1-26**: CDR1前一个位置
  - **FR2-55**: CDR2前一个位置
  - **FR3-104**: CDR3前一个位置
- 比较VHH和Human模板的关键位置残基
- 计算关键位置兼容性得分

### 3. 综合评分排序 ✅
- **评分公式**: `综合得分 = framework_identity × cdr_compatibility_score × key_position_score`
- 综合考虑框架相似性、CDR构型兼容性和关键位置匹配
- 按综合得分排序，选择最佳模板

**示例输出**:
```
候选模板数: 3
  1. HUMAN_VH3_SCF_03_SAFE_A:
     框架identity: 55.0% | CDR兼容性: 95.0% | 关键位置: 100.0%
     综合得分: 0.522
```

## 当前实现：框架优先 + CDR构型筛选 + 关键位置检查

### 匹配流程

```
输入VHH序列
    ↓
1. IMGT编号和切分（提取FR和CDR）
    ↓
2. 框架匹配（计算与羊驼scaffold的identity）
    ↓
3. CDR构型识别（识别CDR1/CDR2/CDR3的构型）
    ↓
4. 选择Human模板（基于框架identity）
    ↓
5. CDR兼容性评估（评估构型兼容性，生成警告）
    ↓
6. CDR移植（将VHH的CDR移植到Human框架）
    ↓
输出人源化序列
```

### 关键点

1. **框架优先**：
   - 主要基于FR1/FR2/FR3的identity选择模板
   - 高identity通常意味着构型兼容

2. **CDR构型识别**：
   - ✅ 已实现：识别CDR构型类别
   - ✅ 已实现：评估兼容性并生成警告
   - ✅ **已实现**：基于构型筛选框架（过滤兼容性<0.7的模板）

3. **兼容性检查**：
   - 检查CDR长度是否合理
   - 识别VHH特殊特征（长CDR3、非经典二硫键）
   - 生成警告信息
   - ✅ **已实现**：关键位置兼容性检查（FR1-26, FR2-55, FR3-104）

4. **综合评分排序**：
   - ✅ **已实现**：综合考虑框架identity、CDR兼容性、关键位置匹配
   - 按综合得分排序，选择最佳模板

## 与正常抗体人源化的对比

### 正常抗体（IgG）人源化标准流程

```
1. 识别CDR构型（基于长度和关键残基）
    ↓
2. 根据CDR构型筛选兼容的人源框架
    ↓
3. 在兼容框架中选择identity最高的
    ↓
4. CDR移植
```

**关键差异**：
- 正常抗体：**CDR构型优先** → 筛选框架 → 选择最佳
- 当前VHH：**框架优先** → 选择最佳 → 检查CDR构型

## 为什么当前策略可行？

### 1. VHH的特殊性

- **框架灵活性高**：VHH框架对CDR构型的容忍度较高
- **CDR3多样性**：VHH的CDR3长度变化大（2-35aa），难以严格分类
- **结构稳定性**：VHH作为单域抗体，结构相对稳定

### 2. 框架相似性通常意味着构型兼容

- 高框架identity → 关键位置（FR1-26, FR2-55）通常一致
- 关键位置一致 → CDR构型通常兼容
- 因此框架优先策略在大多数情况下是可行的

### 3. 辅助检查机制

- CDR构型识别提供额外信息
- 兼容性评估生成警告
- 用户可以基于警告手动调整

## 当前实现的优势

1. **简单高效**：框架匹配速度快，适合大规模处理
2. **信息完整**：提供CDR构型和兼容性信息
3. **灵活可调**：用户可以基于警告手动筛选

## 当前实现的限制

1. **未基于构型筛选**：
   - 可能选择构型不兼容的模板
   - 需要用户手动检查警告

2. **构型识别简化**：
   - 主要基于长度
   - 未考虑关键位置残基

3. **兼容性评估启发式**：
   - 基于经验规则
   - 未使用结构数据验证

## 改进建议

### 短期改进（可立即实现）

1. **构型兼容性过滤**
   ```python
   # 在select_human_templates中
   # 过滤掉兼容性得分过低的模板
   compatible_templates = [
       t for t in candidates
       if t['cdr_compatibility']['compatibility_score'] > threshold
   ]
   ```

2. **综合评分排序**
   ```python
   # 综合得分 = framework_identity × cdr_compatibility_score
   combined_score = (
       framework_identity * 
       cdr_compatibility_score
   )
   ```

### 长期改进（需要更多数据）

1. **框架-构型兼容性矩阵**
   - 建立Human框架与CDR构型的兼容性数据库
   - 基于已知结构数据

2. **关键位置检查**
   - 检查FR1位置26、FR2位置55等关键位置
   - 确保这些位置支持目标CDR构型

3. **结构预测集成**
   - 集成AlphaFold2或其他结构预测工具
   - 验证CDR移植后的结构稳定性

## 使用建议

### 对于标准VHH（CDR长度正常）

- ✅ 当前策略完全适用
- ✅ 框架优先匹配通常足够

### 对于特殊VHH（超长CDR3、非典型构型）

1. **查看所有候选**
   ```python
   result = humanize_vhh(seq, panel='A', top_k=10, return_all_templates=True)
   ```

2. **检查兼容性警告**
   ```python
   for cand in result['candidates']:
       if cand.get('cdr_compatibility', {}).get('warnings'):
           print(f"{cand['template_id']}: {cand['cdr_compatibility']['warnings']}")
   ```

3. **手动筛选**
   - 优先选择兼容性得分高的模板
   - 综合考虑框架identity和CDR兼容性

## 总结

### 当前状态

- ✅ **CDR构型识别**：已实现并集成
- ✅ **兼容性评估**：已实现并生成警告
- ⚠️ **匹配策略**：框架优先（未基于构型筛选）

### 与正常抗体人源化的差异

| 方面 | 正常抗体 | 当前VHH实现 |
|------|---------|------------|
| CDR构型识别 | ✅ 必需 | ✅ 已实现 |
| 基于构型筛选 | ✅ 标准做法 | ✅ **已实现** |
| 框架优先 | ⚠️ 不推荐 | ✅ 当前策略 |
| 兼容性检查 | ✅ 必需 | ✅ 已实现 |
| 关键位置检查 | ✅ 标准做法 | ✅ **已实现** |
| 综合评分排序 | ✅ 标准做法 | ✅ **已实现** |

### 结论

1. **当前策略对大多数VHH是可行的**：框架优先 + CDR构型筛选 + 关键位置检查
2. **综合评分排序**：综合考虑框架identity、CDR兼容性、关键位置匹配
3. **特殊CDR自动处理**：通过CDR构型筛选自动过滤不兼容的模板

