# SAFE 策略解释功能实现总结

## 实现目标

在报告中清晰、可核查地解释 SAFE_A / SAFE_B / SAFE_C 三种策略的：
1. 序列差异在哪里
2. 为什么要这样改
3. 各自对应什么生理学/工程学意义
4. 明确：当前报告为何只对其中一种展开深入评估

---

## 一、概念说明（必须明确）

### 实现位置
- **报告位置**: `## 4. Germline 选择（A/B/C 三条并行路径）` → `### 重要概念说明`
- **JSON 位置**: 无（仅在报告中展示）

### 内容
```
**SAFE_A / SAFE_B / SAFE_C 不是三次人源化方案，而是同一人类 VH3 框架在 FR2 区域不同工程化强度下的三种并列设计策略。**

它们的差异仅存在于 FR2 的少数 hallmark 位点，CDR 序列完全一致，整体 FR 主体保持不变。
```

---

## 二、可核查的序列差异证据

### 实现位置
- **JSON 位置**: `result.json` → `safe_strategies`
- **报告位置**: `### 可核查的序列差异证据（逐位点对齐 IMGT 编号）`

### JSON 结构
```json
{
  "safe_strategies": {
    "SAFE_A": {
      "template_id": "HUMAN_VH3_SCF_10_SAFE_A",
      "fr2_mutations": [
        {
          "imgt_pos": 44,
          "from": "A",
          "to": "Q",
          "meaning": "从疏水残基突变为Q可大幅提高亲水性。Q的酰胺基可参与氢键网络，增强FR2区域的溶解性，降低聚集倾向。 羊驼VHH中44位几乎100%为Q，这是VHH最保守的hallmark位点。"
        },
        {
          "imgt_pos": 45,
          "from": "A",
          "to": "R",
          "meaning": "..."
        }
      ]
    },
    "SAFE_B": {
      "template_id": "HUMAN_VH3_SCF_10_SAFE_B",
      "fr2_mutations": [
        {"imgt_pos": 37, "from": "L", "to": "Y", "meaning": "..."},
        {"imgt_pos": 44, "from": "A", "to": "Q", "meaning": "..."},
        {"imgt_pos": 45, "from": "A", "to": "R", "meaning": "..."},
        {"imgt_pos": 47, "from": "L", "to": "G", "meaning": "..."}
      ]
    },
    "SAFE_C": {
      "template_id": "HUMAN_VH3_SCF_10_SAFE_C",
      "fr2_mutations": [
        {"imgt_pos": 37, "from": "L", "to": "Y", "meaning": "..."},
        {"imgt_pos": 44, "from": "A", "to": "Q", "meaning": "..."},
        {"imgt_pos": 45, "from": "A", "to": "R", "meaning": "..."},
        {"imgt_pos": 47, "from": "L", "to": "G", "meaning": "..."}
      ]
    }
  }
}
```

### 验收标准
✅ **A/B/C 的差异必须能逐位点对齐 IMGT 编号**
- 每个突变都包含 `imgt_pos`（IMGT 位置号）
- 每个突变都包含 `from`（原始残基）和 `to`（目标残基）
- 每个突变都包含 `meaning`（功能意义）

✅ **不允许只写"规则"，必须写"本项目中的实际序列差异"**
- 从实际选中的模板中提取差异
- 基于实际模板的 IMGT 编号结果
- 如果编号结果中没有某个位置，从 SAFE_PLAN_DEFINITIONS 中获取预期突变

---

## 三、生理学/工程学意义解释

### 实现位置
- **报告位置**: `### SAFE_A / SAFE_B / SAFE_C 的工程化强度与生理学意义`

### 内容结构

#### SAFE_A（最温和）
- **改造最少，最接近人类天然 VH 框架**
- **FR2 轻度亲水化，主要目的**：
  - 降低疏水暴露
  - 尽量不改变 VH 的整体折叠
- **生理学含义**：
  - 最大程度保留人类免疫系统'熟悉'的框架
  - 理论上免疫原性风险最低
- **适用场景**：
  - 高度敏感的长期给药
  - 对免疫原性极度保守的项目

#### SAFE_B（中度平衡）
- **在关键 hallmark 位点引入典型 VHH 特征**
- **在'人类 VH 合法空间'与'VHH 结构适配'之间折中**
- **生理学含义**：
  - 提高单域抗体溶解性与稳定性
  - 仍保留较强的人类框架特征
- **适用场景**：
  - 多数标准 VHH 人源化项目（推荐平衡方案）

#### SAFE_C（强 VHH 模式）
- **FR2 hallmark 位点全部调整为经典 VHH 模式**
- **生理学含义**：
  - 最大化补偿缺失轻链带来的疏水界面问题
  - 可能提高表达与稳定性
  - 同时也意味着偏离天然人类 VH 更远
- **风险提示**：
  - 潜在免疫原性风险需后续评估
- **适用场景**：
  - 表达/稳定性优先级高于免疫原性保守性的项目

---

## 四、为什么只评估一种

### 实现位置
- **报告位置**: `### 为什么本报告只对 SAFE_A 进行深入评估？`

### 内容
```
**本报告默认对 SAFE_A 的最优模板进行深入分析，SAFE_B 与 SAFE_C 已完成框架匹配与模板选择，但未在本报告中展开成药性与免疫原性评估；如客户选择，可对任一策略复用同一分析流程并生成对应报告。**

**说明**：
- ✅ 三个策略的框架匹配与模板选择均已完成
- ✅ 三个策略的序列差异已可核查（见上方'可核查的序列差异证据'）
- ✅ 默认深入分析 SAFE_A 是基于其最保守的免疫原性特征
- ✅ 客户可根据项目需求选择任一策略进行完整评估
```

---

## 技术实现

### 1. 新增函数

#### `build_safe_strategies_comparison()`
- **功能**: 构建三个 SAFE 策略的可核查序列差异对比
- **输入**: `germline_selection`, `germline_numberings`, `library_data`
- **输出**: `safe_strategies` 字典

**关键逻辑**:
1. 从 `SAFE_PLAN_DEFINITIONS` 获取预期的突变位点
2. 从 `germline_numberings` 获取实际模板的 IMGT 编号结果
3. 从 `library_data` 的 `mutations` 字段获取原始残基（如果可用）
4. 如果 `mutations` 中没有，从 `HALLMARK_FUNCTIONAL_EXPLANATIONS` 的典型值推断
5. 即使编号结果中没有某个位置，也包含预期的突变（从定义中获取）

### 2. 报告渲染增强

#### 新增章节
1. **重要概念说明**: 明确 SAFE_A/B/C 不是三次人源化，而是三种工程化强度
2. **可核查的序列差异证据**: 逐位点对齐 IMGT 编号的差异表
3. **工程化强度与生理学意义**: 三个策略的详细解释
4. **为什么只评估一种**: 明确说明交付策略

---

## 验收结果

### JSON 验证
✅ `safe_strategies` 字段存在
✅ 三个策略（SAFE_A/B/C）都有 `fr2_mutations`
✅ 每个突变都包含 `imgt_pos`, `from`, `to`, `meaning`
✅ SAFE_A: 2 个突变（44, 45）
✅ SAFE_B: 4 个突变（37, 44, 45, 47）
✅ SAFE_C: 4 个突变（37, 44, 45, 47）

### 报告验证
✅ 概念说明已添加
✅ 可核查的序列差异证据表已添加
✅ 生理学/工程学意义解释已添加
✅ 为什么只评估一种的说明已添加

### 审计验证
✅ 所有审计项通过（7/7）

---

## 文件修改清单

1. **scripts/run_egfr_vhh_end_to_end.py**
   - 新增 `build_safe_strategies_comparison()` 函数
   - 在主流程中调用该函数，生成 `safe_strategies` 字段
   - 修改 `render_md_from_json()` 函数，添加四个新章节

---

## 一句话总结

**系统已从"我们有三种方案"升级为"我们理解三种方案在生理学与工程学上的取舍，并能为客户解释清楚"。**













